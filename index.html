<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy | Care</title>
    <link rel="icon" type="image/png" href="icon_easycare.png">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- ===== Claim Receipt Styles (embedded, used only when printing claim receipt) ===== -->
    <style id="claimReceiptStyles">
        /* These styles are scoped to #claimReceiptView and the @media print block */
        #claimReceiptView {
            display: none;
            font-family: 'Angsana New', 'TH Sarabun New', 'Sarabun', sans-serif;
            font-size: 18px;
            background-color: #f0f0f0;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        #claimReceiptView .cr-page {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm 15mm;
            margin: 5mm auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        #claimReceiptView .cr-page-content {
            flex-grow: 1;
        }

        #claimReceiptView .cr-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        #claimReceiptView .cr-logo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #claimReceiptView .cr-company-name {
            text-align: center;
            flex-grow: 1;
        }

        #claimReceiptView .cr-company-name h1 {
            margin: 0;
            font-size: 26px;
            font-weight: bold;
        }

        #claimReceiptView .cr-company-name h2 {
            margin: 5px 0;
            font-size: 22px;
            font-weight: normal;
        }

        #claimReceiptView .cr-date-section {
            text-align: right;
            padding-top: 40px;
        }

        #claimReceiptView .cr-form-container {
            border: 1.5px solid #000;
            width: 100%;
        }

        #claimReceiptView .cr-row {
            display: flex;
            border-bottom: 1px solid #000;
            box-sizing: border-box;
        }

        #claimReceiptView .cr-row:last-child {
            border-bottom: none;
        }

        #claimReceiptView .cr-col {
            padding: 8px 10px;
            border-right: 1px solid #000;
            box-sizing: border-box;
        }

        #claimReceiptView .cr-col:last-child {
            border-right: none;
        }

        #claimReceiptView .cr-section-title {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        #claimReceiptView .cr-section-header-row {
            background-color: #f9f9f9;
        }

        #claimReceiptView .cr-w-25 {
            width: 25%;
        }

        #claimReceiptView .cr-w-30 {
            width: 30%;
        }

        #claimReceiptView .cr-w-33 {
            width: 33.33%;
        }

        #claimReceiptView .cr-w-40 {
            width: 40%;
        }

        #claimReceiptView .cr-w-50 {
            width: 50%;
        }

        #claimReceiptView .cr-w-60 {
            width: 60%;
        }

        #claimReceiptView .cr-w-70 {
            width: 70%;
        }

        #claimReceiptView .cr-w-100 {
            width: 100%;
        }

        #claimReceiptView .cr-field {
            margin-bottom: 6px;
            display: flex;
            align-items: baseline;
        }

        #claimReceiptView .cr-label {
            margin-right: 5px;
        }

        #claimReceiptView .cr-dotted-line {
            border-bottom: 1px dotted #000;
            display: inline-block;
            min-height: 1.2em;
            padding: 0 5px;
            flex: 1;
        }

        #claimReceiptView .cr-signature-section {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        #claimReceiptView .cr-sig-block {
            width: 30%;
        }

        #claimReceiptView .cr-sig-line {
            border-bottom: 1px dotted #000;
            margin-bottom: 5px;
            padding-top: 50px;
            min-height: 70px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        #claimReceiptView .cr-signature-img {
            max-height: 60px;
            max-width: 90%;
            object-fit: contain;
        }

        #claimReceiptView .cr-sig-name {
            margin-top: 5px;
            font-size: 16px;
        }

        #claimReceiptView .cr-terms-list {
            list-style: none;
            counter-reset: terms-counter;
            font-size: 15px;
            line-height: 1.6;
            margin: 10px 0;
            padding-left: 0;
        }

        #claimReceiptView .cr-terms-list li {
            counter-increment: terms-counter;
            margin-bottom: 6px;
            padding-left: 25px;
            position: relative;
        }

        #claimReceiptView .cr-terms-list li::before {
            content: counter(terms-counter) ".";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        #claimReceiptView .cr-images-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        #claimReceiptView .cr-images-grid img {
            height: 80px;
            width: 80px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #claimReceiptView .cr-print-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        #claimReceiptView .cr-print-button {
            background: #1e40af;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #claimReceiptView .cr-print-button:hover {
            background: #1e3a8a;
        }

        #claimReceiptView .cr-close-button {
            background: #64748b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        #claimReceiptView .cr-close-button:hover {
            background: #475569;
        }

        /* ===== Print styles: when printing, hide app and show only receipt ===== */
        @media print {

            /* Hide everything except the receipt */
            body>*:not(#claimReceiptView) {
                display: none !important;
            }

            #claimReceiptView {
                display: block !important;
                background: none;
                padding: 0;
            }

            #claimReceiptView .cr-print-buttons {
                display: none !important;
            }

            #claimReceiptView .cr-page {
                margin: 0;
                box-shadow: none;
                page-break-after: always;
            }
        }
    </style>
</head>

<body>
    <!-- Global Loader Overlay -->
    <div id="global-loader" class="global-loader">
        <div class="loader-content">
            <div class="loader-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p class="loader-text">กำลังโหลด...</p>
        </div>
    </div>

    <!-- App Container --->
    <div id="app">

        <!-- Login View -->
        <div id="loginView" class="view auth-page" style="display: none;">
            <div class="login-container">
                <div class="login-card">
                    <header>
                        <img src="logo_easycare.png" alt="EasyCare Logo" class="logo">
                        <h1>เข้าสู่ระบบเจ้าหน้าที่</h1>
                        <p>ยินดีต้อนรับกลับมา กรุณาลงชื่อเข้าใช้งาน</p>
                    </header>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="username">ชื่อผู้ใช้งาน</label>
                            <input type="text" id="username" placeholder="ระบุชื่อผู้ใช้งาน" required>
                        </div>
                        <div class="form-group">
                            <label for="password">รหัสผ่าน</label>
                            <input type="password" id="password" placeholder="••••••••" required>
                        </div>
                        <div id="loginError" class="error-text" style="display: none;">
                            ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง</div>
                        <button type="submit" class="submit-btn full-width">
                            <span>เข้าสู่ระบบ</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </button>
                        <div class="auth-footer">
                            <p>ยังไม่มีบัญชีผู้ใช้? <a href="#" id="toRegister">ลงทะเบียนใหม่</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Staff Registration View -->
        <div id="staffRegisterView" class="view auth-page" style="display: none;">
            <div class="login-container">
                <div class="login-card">
                    <header>
                        <img src="logo_easycare.png" alt="EasyCare Logo" class="logo">
                        <h1>ลงทะเบียนเจ้าหน้าที่ใหม่</h1>
                        <p>สร้างบัญชีเจ้าหน้าที่เพื่อจัดการระบบ</p>
                    </header>
                    <form id="staffRegisterForm">
                        <div class="form-group">
                            <label for="regStaffName">ชื่อ-นามสกุล</label>
                            <input type="text" id="regStaffName" placeholder="เช่น นายสมชาย ใจดี" required>
                        </div>
                        <div class="form-group">
                            <label for="regStaffPosition">ตำแหน่ง/หน้าที่</label>
                            <input type="text" id="regStaffPosition" placeholder="เช่น พนักงานขาย" required>
                        </div>
                        <div class="form-group">
                            <label for="regUsername">ชื่อผู้ใช้งาน</label>
                            <input type="text" id="regUsername" placeholder="เช่น admin_smile" required>
                        </div>
                        <div class="form-group">
                            <label for="regPassword">รหัสผ่าน</label>
                            <input type="password" id="regPassword" placeholder="••••••••" required>
                        </div>
                        <div id="regError" class="error-text" style="display: none;">ชื่อผู้ใช้งานนี้มีอยู่ในระบบแล้ว
                        </div>
                        <button type="submit" class="submit-btn full-width">
                            <span>ลงทะเบียนบัญชี</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </button>
                        <div class="auth-footer">
                            <p>มีบัญชีอยู่แล้ว? <a href="#" id="toLogin">เข้าสู่ระบบ</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="view dashboard-page" style="display: none;">
            <div class="sidebar-overlay" id="sidebarOverlay"></div>

            <!-- Mobile Header Bar -->
            <div class="mobile-header">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="mobile-logo-text">Easy<span>Care</span></div>
                <div style="width: 40px;"></div>
            </div>

            <div class="dashboard-container">
                <aside class="sidebar" id="sidebar">
                    <img src="logo_easycare.png" alt="EasyCare Logo" class="logo">
                    <nav>
                        <a href="#" id="dashNavLink" class="active">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            แพ็กเกจ
                        </a>
                        <a href="#" id="membersNavLink">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            สมาชิก
                        </a>
                        <a href="#" id="shopsNavLink">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            ร้านค้า
                        </a>
                        <a href="#" id="claimsNavLink">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            แจ้งเคลม
                        </a>
                        <a href="#" id="statusTrackingNavLink">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                            ติดตามสถานะ
                        </a>
                        <a href="#" id="approvalNavLink">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            อนุมัติสัญญา
                            <span id="approvalBadge" class="nav-badge" style="display: none;">0</span>
                        </a>
                    </nav>
                    <div class="sidebar-footer">
                        <div class="staff-info">
                            <div class="staff-avatar" id="staffInitial">A</div>
                            <div class="staff-details">
                                <p class="staff-name" id="displayStaffName">เจ้าหน้าที่</p>
                                <p class="staff-role" id="displayStaffPosition">ผู้ดูแลระบบ</p>
                            </div>
                        </div>
                        <button id="logoutBtn" class="logout-link">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            ออกจากระบบ
                        </button>
                    </div>
                </aside>

                <!-- Dashboard Main Content -->
                <main id="dashMain" class="main-content">
                    <header class="dashboard-header">
                        <div class="header-titles">
                            <h1>รายการประกันเครื่องทั้งหมด</h1>
                            <p>จัดการและติดตามข้อมูลประกันภัยมือถือของลูกค้า</p>
                        </div>
                        <button id="addNewBtn" class="add-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            สร้างสัญญาใหม่
                        </button>
                    </header>

                    <div class="stats-overview">
                        <div class="stat-card">
                            <div class="stat-icon purple">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalRecords">0</h3>
                                <p>ทั้งหมด (Total)</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <h3 id="activeRecords">0</h3>
                                <p>ปกติ (Active)</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                                    </path>
                                    <line x1="12" y1="9" x2="12" y2="13"></line>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                            </div>
                            <div class="stat-content">
                                <h3 id="expiringSoon">0</h3>
                                <p>ใกล้หมดอายุ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="search-container">
                            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInput"
                                placeholder="ค้นหาด้วย ชื่อ, รหัสสมาชิก หรือเบอร์โทรศัพท์...">
                        </div>

                        <div class="filter-group">
                            <label>สถานะ:</label>
                            <select id="statusFilter" class="filter-select">
                                <option value="all">ทั้งหมด</option>
                                <option value="active">ปกติ (Active)</option>
                                <option value="expired">หมดอายุ (Expired)</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label>การชำระเงิน:</label>
                            <select id="paymentFilter" class="filter-select">
                                <option value="all">ทั้งหมด</option>
                                <option value="full">ชำระเต็มจำนวน</option>
                                <option value="installment">ชำระเป็นงวด</option>
                                <option value="installment_complete">ชำระเป็นงวดครบแล้ว</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="recordsTable">
                            <thead>
                                <tr>
                                    <th>วันที่ทำรายการ</th>
                                    <th>เลขกรมธรรม์</th>
                                    <th>รหัสสมาชิก</th>
                                    <th>ชื่อลูกค้า</th>
                                    <th>เบอร์โทรศัพท์</th>
                                    <th>รุ่นอุปกรณ์</th>
                                    <th>แพ็กเกจ</th>
                                    <th>ประกันคงเหลือ</th>
                                    <th>วงเงินคงเหลือ</th>
                                    <th>ร้านค้า</th>
                                    <th>ผู้บันทึก</th>
                                    <th>สถานะ</th>
                                    <th>การชำระเงิน</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="recordsBody"></tbody>
                        </table>
                        <div id="emptyState" class="empty-state" style="display: none;">
                            <p>ไม่พบข้อมูลในขณะนี้ คลิก "สร้างสัญญาใหม่"</p>
                        </div>
                    </div>
                </main>

                <!-- Members Main Content -->
                <main id="membersMain" class="main-content" style="display: none;">
                    <header class="dashboard-header">
                        <div class="header-titles">
                            <h1>ข้อมูลสมาชิก</h1>
                            <p>จัดการข้อมูลลูกค้าและที่อยู่สำหรับจัดส่ง</p>
                        </div>
                        <button id="addMemberBtn" class="add-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            เพิ่มสมาชิกใหม่
                        </button>
                    </header>

                    <div class="table-container">
                        <table id="membersTable">
                            <thead>
                                <tr>
                                    <th>รหัสสมาชิก</th>
                                    <th>ชื่อ-นามสกุล</th>
                                    <th>เบอร์โทรศัพท์</th>
                                    <th>ที่อยู่ตามบัตร (ID Card Address)</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="membersBody"></tbody>
                        </table>
                        <div id="membersEmptyState" class="empty-state" style="display: none;">
                            <p>ยังไม่มีข้อมูลสมาชิกในขณะนี้</p>
                        </div>
                    </div>
                </main>

                <!-- Shops Main Content -->
                <main id="shopsMain" class="main-content" style="display: none;">
                    <header class="dashboard-header">
                        <div class="header-titles">
                            <h1>ข้อมูลร้านค้าพันธมิตร</h1>
                            <p>จัดการรายชื่อร้านค้าที่ร่วมรายการและสถานที่ตั้ง</p>
                        </div>
                        <button id="addShopBtn" class="add-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            เพิ่มร้านค้าใหม่
                        </button>
                    </header>

                    <div class="table-container">
                        <table id="shopsTable">
                            <thead>
                                <tr>
                                    <th>รหัสร้านค้า</th>
                                    <th>ชื่อร้านค้า</th>
                                    <th>สถานที่ตั้ง (Location)</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="shopsBody"></tbody>
                        </table>
                        <div id="shopsEmptyState" class="empty-state" style="display: none;">
                            <p>ยังไม่มีข้อมูลร้านค้าในขณะนี้</p>
                        </div>
                    </div>
                </main>

                <!-- Claims Main Content -->
                <main id="claimsMain" class="main-content" style="display: none;">
                    <header class="dashboard-header">
                        <div class="header-titles">
                            <h1>เมนูแจ้งเคลม</h1>
                            <p>รายการกรมธรรม์ที่มีสถานะปกติ (Active) สำหรับทำรายการเคลม</p>
                        </div>
                    </header>

                    <div class="table-container">
                        <table id="claimsTable">
                            <thead>
                                <tr>
                                    <th>วันที่ลงทะเบียน</th>
                                    <th>เลขกรมธรรม์</th>
                                    <th>รหัสสมาชิก</th>
                                    <th>ชื่อลูกค้า</th>
                                    <th>เบอร์โทรศัพท์</th>
                                    <th>รุ่นอุปกรณ์</th>
                                    <th>แพ็กเกจ</th>
                                    <th>ประกันคงเหลือ</th>
                                    <th>สถานะ</th>
                                    <th>ทำรายการ</th>
                                </tr>
                            </thead>
                            <tbody id="claimsBody"></tbody>
                        </table>
                        <div id="claimsEmptyState" class="empty-state" style="display: none;">
                            <p>ไม่มีกรมธรรม์ที่มีสถานะปกติในขณะนี้</p>
                        </div>
                    </div>
                </main>

                <!-- Status Tracking Main Content -->
                <main id="statusTrackingMain" class="main-content" style="display: none;">
                    <header class="dashboard-header">
                        <div class="header-titles">
                            <h1>ติดตามสถานะการซ่อม</h1>
                            <p>รายการเคลมที่อยู่ระหว่างดำเนินการ (สถานะ: รอเคลม)</p>
                        </div>
                    </header>

                    <div class="table-container">
                        <table id="statusTrackingTable">
                            <thead>
                                <tr>
                                    <th>รหัสเคลม</th>
                                    <th>วันที่แจ้งเคลม</th>
                                    <th>ชื่อลูกค้า</th>
                                    <th>เบอร์โทรศัพท์</th>
                                    <th>อุปกรณ์</th>
                                    <th>สถานะ</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="statusTrackingBody"></tbody>
                        </table>
                        <div id="statusTrackingEmptyState" class="empty-state" style="display: none;">
                            <p>ไม่มีรายการเคลมที่อยู่ระหว่างดำเนินการ</p>
                        </div>
                    </div>
                </main>

                <!-- Approval Main Content -->
                <main id="approvalMain" class="main-content" style="display: none;">
                    <header class="dashboard-header">
                        <div class="header-titles">
                            <h1>อนุมัติสัญญาประกัน</h1>
                            <p>ตรวจสอบและอนุมัติ/ไม่อนุมัติสัญญาประกันภัยใหม่</p>
                        </div>
                    </header>

                    <!-- Filter Tabs -->
                    <div class="approval-filter-tabs">
                        <button class="approval-tab-btn active" data-status="pending">⏳ รออนุมัติ <span class="badge"
                                id="badgePending">0</span></button>
                        <button class="approval-tab-btn" data-status="approved">✅ อนุมัติแล้ว <span class="badge"
                                id="badgeApproved">0</span></button>
                        <button class="approval-tab-btn" data-status="rejected">❌ ไม่อนุมัติ <span class="badge"
                                id="badgeRejected">0</span></button>
                    </div>

                    <!-- Live Update Bar -->
                    <div class="approval-header-bar">
                        <div id="approvalLiveIndicator" class="live-indicator">
                            <span class="live-dot"></span>
                            <span id="approvalLiveText">Live Update</span>
                        </div>
                        <button id="btnApprovalToggleRefresh" class="btn-toggle-refresh"
                            title="หยุด/เริ่ม Auto-Refresh">
                            ⏸ หยุดชั่วคราว
                        </button>
                    </div>

                    <div class="table-container">
                        <table id="approvalTable">
                            <thead>
                                <tr>
                                    <th>เลขกรมธรรม์</th>
                                    <th>ชื่อลูกค้า</th>
                                    <th>รุ่นอุปกรณ์</th>
                                    <th>แพ็กเกจ</th>
                                    <th>ร้านค้า</th>
                                    <th>สถานะ</th>
                                    <th>ดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="approvalBody"></tbody>
                        </table>
                        <div id="approvalEmptyState" class="empty-state" style="display: none;">
                            <p>ไม่พบรายการสัญญาในหมวดนี้</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    </div>

    <!-- Registration View -->
    <div id="registrationView" class="view" style="display: none; padding: 2rem 1rem;">
        <div class="container">
            <header class="form-header">
                <img src="logo_easycare.png" alt="EasyCare Logo" class="logo">
                <h1 id="regFormTitle">ลงทะเบียนประกันภัย</h1>
                <p id="regFormSubtitle">ประกันคุ้มครองมือถือ iPhone & iPad</p>
            </header>

            <form id="warrantyForm">
                <input type="hidden" id="editRecordId">
                <!-- User Info -->
                <section>
                    <div class="section-header"><span class="step-number">01</span>
                        <h2>ข้อมูลสมาชิก</h2>
                    </div>

                    <!-- Member Search Box -->
                    <div class="form-group full-width" style="margin-bottom: 2rem;">
                        <label>ค้นหาสมาชิก (เลขที่สมาชิก / เลขบัตรประชาชน / เบอร์โทร / ชื่อ-นามสกุล)</label>
                        <div class="search-container">
                            <input type="text" id="memberSearchInput"
                                placeholder="พิมพ์เพื่อค้นหา (เช่น ชื่อ หรือ เลขบัตร)..." autocomplete="off"
                                style="border: 2px solid var(--primary); padding-left: 3rem;">
                            <span
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--primary);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </span>
                            <div id="memberSearchResults" class="search-results-dropdown"></div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="form-group"><label>เลขกรมธรรม์ (กธ.)</label><input type="text" id="policyNumber"
                                readonly class="readonly-field" placeholder="ออกโดยระบบอัตโนมัติ"></div>
                        <div class="form-group"><label>รหัสสมาชิก</label><input type="text" id="memberId"
                                placeholder="รหัสสมาชิก"></div>
                        <div class="form-group"><label>ชื่อ</label><input type="text" id="firstName" required></div>
                        <div class="form-group"><label>นามสกุล</label><input type="text" id="lastName" required>
                        </div>
                        <div class="form-group"><label>เบอร์โทรศัพท์</label><input type="tel" id="phone" required
                                placeholder="0xxxxxxxxx"></div>
                        <div class="form-group">
                            <label>ร้านค้า (Shop)</label>
                            <select id="shopName" required>
                                <option value="" disabled selected>โหลดข้อมูลร้านค้า...</option>
                            </select>
                        </div>
                        <div class="form-group"><label>วันเกิด (พ.ศ.)</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="number" id="dobDay" placeholder="วัน" min="1" max="31" required
                                    style="width: 80px;">
                                <input type="number" id="dobMonth" placeholder="เดือน" min="1" max="12" required
                                    style="width: 80px;">
                                <input type="number" id="dobYear" placeholder="ปี พ.ศ." min="2400" max="2600" required>
                            </div>
                        </div>
                        <div class="form-group"><label>อายุ</label><input type="text" id="age" readonly
                                class="readonly-field" placeholder="คำนวณอัตโนมัติ"></div>
                        <div class="form-group full-width"><label>ที่อยู่</label><textarea id="address" rows="3"
                                required></textarea></div>
                    </div>
                </section>

                <!-- Device Info -->
                <section>
                    <div class="section-header"><span class="step-number">02</span>
                        <h2>รายละเอียดอุปกรณ์</h2>
                    </div>
                    <div class="grid-row">
                        <div class="form-group">
                            <label>ประเภทสินค้า</label>
                            <select id="productType" required>
                                <option value="" disabled selected>เลือกประเภท</option>
                                <option value="iPhone">iPhone</option>
                                <option value="iPad">iPad</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>รุ่น (Model)</label>
                            <select id="model" required>
                                <option value="" disabled selected>เลือก</option>
                                <option value="iPhone 13">iPhone 13</option>
                                <option value="iPhone 15">iPhone 15</option>
                                <option value="iPhone 16">iPhone 16</option>
                                <option value="iPhone 16 Plus">iPhone 16 Plus</option>
                                <option value="iPhone 16 Pro">iPhone 16 Pro</option>
                                <option value="iPhone 16 Pro Max">iPhone 16 Pro Max</option>
                                <option value="iPhone 17 256">iPhone 17 256</option>
                                <option value="iPhone 17 Pro">iPhone 17 Pro</option>
                                <option value="iPhone 17 Pro Max">iPhone 17 Pro Max</option>
                                <option value="iPad Gen11">iPad Gen11</option>
                                <option value="iPad Air7">iPad Air7</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>สี (Color)</label>
                            <select id="color" required>
                                <option value="" disabled selected>เลือกสี</option>
                                <option value="สีดำ">สีดำ (Black)</option>
                                <option value="สีขาว">สีขาว (White)</option>
                                <option value="บลู">บลู (Blue)</option>
                                <option value="ชมพู">ชมพู (Pink)</option>
                                <option value="เขียว">เขียว (Green)</option>
                                <option value="ม่วง">ม่วง (Purple)</option>
                                <option value="ส้ม">ส้ม (Orange)</option>
                                <option value="เทา">เทา (Gray)</option>
                                <option value="กราไฟต์">กราไฟต์ (Graphite)</option>
                                <option value="ทะเลทราย">ทะเลทราย (Desert)</option>
                                <option value="ไทเทเนียมทะเลทราย">ไทเทเนียมทะเลทราย (Desert Titanium)</option>
                                <option value="ไวท์ไทเทเนียม">ไวท์ไทเทเนียม (White Titanium)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ความจุ (Capacity)</label>
                            <select id="capacity" required>
                                <option value="" disabled selected>เลือกความจุ</option>
                                <option value="128GB">128GB</option>
                                <option value="256GB">256GB</option>
                                <option value="512GB">512GB</option>
                                <option value="1TB">1TB</option>
                                <option value="2TB">2TB</option>
                            </select>
                        </div>
                        <div class="form-group"><label>เลขซีเรียล (Serial Number)</label>
                            <input type="text" id="serialNumber" required minlength="10" maxlength="10"
                                placeholder="ต้องครบ 10 หลัก">
                        </div>
                        <div class="form-group" id="imeiGroup"><label>เลข IMEI</label>
                            <input type="text" id="imei" minlength="15" maxlength="15" pattern="\d{15}"
                                placeholder="ตัวเลข 15 หลัก">
                        </div>
                        <div class="form-group"><label>วันสิ้นสุดประกันศูนย์</label>
                            <input type="date" id="officialWarrantyEnd" required>
                        </div>
                        <div class="form-group"><label>มูลค่าเครื่อง (Device Value)</label>
                            <input type="number" id="deviceValue" placeholder="ระบุมูลค่าเครื่อง (บาท)" required>
                        </div>
                    </div>
                </section>

                <!-- Warranty & Payment -->
                <section>
                    <div class="section-header"><span class="step-number">03</span>
                        <h2>การคุ้มครองและแพ็กเกจ</h2>
                    </div>
                    <div class="grid-row">
                        <div class="form-group">
                            <label>ประเภทการคุ้มครอง (Protection Type)</label>
                            <select id="protectionType" required>
                                <option value="Full">คุ้มครองทั้งเครื่อง</option>
                                <option value="ScreenApple">คุ้มครองเฉพาะหน้าจอ (จอแท้จากศูนย์Apple)</option>
                                <option value="ScreenCompany">คุ้มครองเฉพาะหน้าจอ (จอแท้จากบริษัท)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>แพ็กเกจ (Package)</label>
                            <select id="package" required>
                                <option value="" disabled selected>เลือกแผนประกัน</option>
                                <option value="Plan A">Plan A</option>
                                <option value="Plan B">Plan B</option>
                                <option value="Plan C">Plan C</option>
                                <option value="Plan D">Plan D</option>
                                <option value="Plan a">Plan a</option>
                                <option value="Plan b">Plan b</option>
                                <option value="Plan c">Plan c</option>
                            </select>
                        </div>
                        <div class="form-group"><label>วันที่เริ่มคุ้มครอง</label>
                            <input type="text" id="startDateDisplay" readonly class="readonly-field"
                                value="วันที่ลงทะเบียน">
                        </div>
                        <div class="form-group"><label>วันที่สิ้นสุด</label>
                            <input type="text" id="endDateDisplay" readonly class="readonly-field"
                                value="1 ปีหลังจากเริ่ม">
                        </div>
                        <input type="hidden" id="startDate">
                        <input type="hidden" id="endDate">
                        <div class="form-group"><label>จำนวนวันคุ้มครอง</label><input type="number" id="remainingDays"
                                readonly class="readonly-field"></div>
                    </div>

                    <div id="pricingSummary" class="pricing-summary">
                        <div class="price-row"><span>ราคาแพ็กเกจฐาน:</span><span id="packagePriceText">0
                                บาท</span></div>
                        <div class="price-row total"><span>ยอดรวมสุทธิ:</span><span id="totalPriceText">0
                                บาท</span></div>
                    </div>

                    <div class="form-group radio-group">
                        <label>วิธีการชำระเงิน</label>
                        <div class="radio-options">
                            <label class="radio-label"><input type="radio" name="paymentMethod" value="Full Payment"
                                    checked><span class="radio-custom"></span>ชำระเต็มจำนวน</label>
                            <label class="radio-label"><input type="radio" name="paymentMethod"
                                    value="Installment"><span class="radio-custom"></span>ผ่อนชำระ (3 งวด)</label>
                        </div>
                    </div>

                    <div id="initialPaymentCheck" class="form-group" style="margin-top: 1rem;"></div>

                    <div id="installmentContainer" class="installment-preview" style="display: none;">
                        <h3>รายละเอียดการผ่อนชำระ</h3>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>งวดที่</th>
                                    <th>จำนวนเงิน (บาท)</th>
                                    <th>วันครบกำหนด</th>
                                    <th>สิ้นสุดระยะผ่อนผัน</th>
                                </tr>
                            </thead>
                            <tbody id="installmentBody"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Payment Management (Only shown in Edit Mode) -->
                <section id="paymentManagementSection" class="payment-status-section" style="display: none;">
                    <div class="section-header"><span class="step-number">04</span>
                        <h2>จัดการการชำระเงิน</h2>
                    </div>

                    <!-- Debt Summary -->
                    <div class="debt-summary-container"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="payment-info-card"
                            style="background: #f8fafc; border-left: 4px solid var(--text-muted);">
                            <div>
                                <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">ยอดหนี้ทั้งหมด</p>
                                <h3 id="debtSummaryTotal" style="margin: 5px 0 0 0; color: var(--text-main);">0 บาท</h3>
                            </div>
                        </div>
                        <div class="payment-info-card" style="background: #fff7ed; border-left: 4px solid #f97316;">
                            <div>
                                <p style="color: #9a3412; font-size: 0.85rem; margin: 0;">ยอดหนี้คงเหลือ</p>
                                <h3 id="debtSummaryRemaining" style="margin: 5px 0 0 0; color: #c2410c;">0 บาท</h3>
                            </div>
                        </div>
                    </div>
                    <div id="fullPaymentStatus" style="display: none;">
                        <div class="payment-info-card">
                            <div>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">ยอดรวมทั้งหมด</p>
                                <h3 id="fullPaymentAmount" style="margin: 0;">0 บาท</h3>
                            </div>
                            <div style="text-align: right;">
                                <p id="fullPaymentStatusText" style="margin-bottom: 0.5rem;"></p>
                                <button type="button" id="confirmFullPaymentBtn"
                                    class="receive-btn">ยืนยันการรับชำระ</button>
                            </div>
                        </div>
                    </div>
                    <div id="installmentStatus" style="display: none;">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>งวดที่</th>
                                    <th>ยอดเงิน (บาท)</th>
                                    <th>วันครบกำหนด</th>
                                    <th>สถานะ</th>
                                    <th>จัดการ</th>
                                    <th>พิมพ์</th>
                                </tr>
                            </thead>
                            <tbody id="paymentStatusBody"></tbody>
                        </table>
                        <div id="payAllRemainingContainer" style="display: none; margin-top: 1rem; text-align: right;">
                            <button type="button" id="payAllRemainingBtn" class="receive-btn"
                                style="background: var(--bg-sidebar-solid);">💰 ชำระเงินงวดที่เหลือทั้งหมด</button>
                        </div>
                    </div>
                </section>

                <div class="form-actions">
                    <button type="button" id="backToDashBtn" class="submit-btn"
                        style="background: var(--text-muted); margin-right: 1rem;">ย้อนกลับ</button>
                    <button type="submit" class="submit-btn"><span>บันทึกข้อมูลการลงทะเบียน</span></button>
                </div>
            </form>
        </div>
    </div>

    <!-- =================== MODALS =================== -->

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="success-icon">✓</div>
            <h2 id="successModalTitle">บันทึกข้อมูลสำเร็จ!</h2>
            <p id="successModalText">ข้อมูลประกันภัยของคุณถูกบันทึกลงในระบบเรียบร้อยแล้ว</p>

            <!-- Advanced Checkout Section (Step 1: Payment Selection) -->
            <div id="checkoutStep1" class="checkout-step" style="display: none; margin: 1.5rem 0; text-align: left;">
                <div
                    style="background: #f1f5f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: var(--text-main);">ยอดที่ต้องชำระ:</span>
                    <span id="checkoutTotalDue" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">0.00
                        บาท</span>
                </div>

                <div class="payment-tabs">
                    <button type="button" class="pay-tab-btn active" data-method="Cash">💵 เงินสด</button>
                    <button type="button" class="pay-tab-btn" data-method="Transfer">📱 โอนเงิน</button>
                    <button type="button" class="pay-tab-btn" data-method="Split">⚖️ แบ่งจ่าย</button>
                </div>

                <div id="cashInputGroup" class="payment-group">
                    <label>รับเงินสดมา (บาท)</label>
                    <input type="number" id="cashReceivedInput" placeholder="0.00" class="full-width"
                        style="font-size: 1.2rem;">
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; font-weight: 600;">
                        <span>เงินทอน:</span>
                        <span id="cashChangeAmount" style="color: #ef4444; font-size: 1.2rem;">0.00 บาท</span>
                    </div>
                </div>

                <div id="transferInputGroup" class="payment-group" style="display: none;">
                    <label>ยอดโอน (บาท)</label>
                    <input type="number" id="transferAmountInput" placeholder="0.00" class="full-width"
                        style="font-size: 1.2rem;">
                    <label style="margin-top: 10px;">เลขที่อ้างอิง / Slip ID (ถ้ามี)</label>
                    <input type="text" id="transferRefInput" placeholder="Ref ID..." class="full-width">
                </div>

                <div id="splitInputGroup" class="payment-group" style="display: none;">
                    <div class="grid-row" style="gap: 10px;">
                        <div>
                            <label>ส่วนเงินสด (บาท)</label>
                            <input type="number" id="splitCashInput" placeholder="0.00" class="full-width">
                        </div>
                        <div>
                            <label>ส่วนโอน (บาท)</label>
                            <input type="number" id="splitTransferInput" placeholder="0.00" class="full-width">
                        </div>
                    </div>
                    <div class="payment-summary-box" style="margin-top: 1rem; padding: 1rem;">
                        <div class="summary-row">
                            <span>รวมจ่าย:</span>
                            <span id="splitTotalPaid" style="font-weight: 600;">0.00 บาท</span>
                        </div>
                        <div class="summary-row">
                            <span>ส่วนต่าง:</span>
                            <span id="splitBalance" style="font-weight: 600; color: #ef4444;">-0.00 บาท</span>
                        </div>
                        <div id="splitChangeRow" class="summary-row" style="display: none; font-weight: 600;">
                            <span>เงินทอน:</span>
                            <span id="splitChangeAmount" style="color: #ef4444;">0.00 บาท</span>
                        </div>
                    </div>
                </div>

                <button id="goToSummaryBtn" class="submit-btn full-width" style="margin-top: 1.5rem;"
                    disabled>ตรวจสอบข้อมูลสรุป</button>
            </div>

            <!-- Step 2: Summary Section -->
            <div id="checkoutStep2" class="checkout-step" style="display: none; margin: 1.5rem 0; text-align: left;">
                <h3
                    style="margin-bottom: 1rem; color: var(--text-main); font-size: 1.1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
                    📃 สรุปรายการชำระเงิน</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>ราคาแพ็กเกจ:</span>
                        <span id="summaryTotalDue" style="font-weight: 600;">0.00 บาท</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ชำระด้วยเงินสด:</span>
                        <span id="summaryCashPaid">0.00 บาท</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ชำระด้วยการโอน:</span>
                        <span id="summaryTransferPaid">0.00 บาท</span>
                    </div>
                    <div id="summaryChangeRow"
                        style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #cbd5e1;">
                        <span style="font-weight: 700;">เงินทอน (Cash Change):</span>
                        <span id="summaryChangeAmount" style="color: #ef4444; font-weight: 800; font-size: 1.2rem;">0.00
                            บาท</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                    <button id="backToInputBtn" class="btn-secondary">⬅️ ย้อนกลับ</button>
                    <button id="finalConfirmBtn" class="submit-btn" style="flex: 2; margin: 0;">ยืนยันจ่าย &
                        พิมพ์ใบเสร็จ</button>
                </div>
            </div>

            <!-- Step 3: Transaction Complete -->
            <div id="checkoutStep3" class="checkout-step"
                style="display: none; margin: 1.5rem 0; padding: 1rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">🎉</div>
                <h3 style="color: #166534; margin-bottom: 0.5rem;">การทำรายการเสร็จสมบูรณ์</h3>
                <p style="color: #15803d; font-size: 0.9rem;">ระบบได้บันทึกการชำระเงินและเปิดใบเสร็จให้คุณแล้ว</p>
                <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                    <button id="reprintReceiptBtn" class="receive-btn" style="flex: 1; margin: 0;">🖨️
                        พิมพ์ใบเสร็จอีกครั้ง</button>
                    <button id="finishProcessBtn" class="submit-btn" style="flex: 1; margin: 0; background: #22c55e;">✅
                        กลับสู่หน้าหลัก</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 1rem;">
                <button id="closeModal" class="btn-cancel">✕ ปิด</button>
            </div>
        </div>
    </div>

    <!-- Member Form Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="memberModalTitle">เพิ่มข้อมูลสมาชิก</h2>
            <div style="margin-bottom: 1.5rem;">
                <button type="button" id="readSmartCardBtn" class="submit-btn full-width"
                    style="background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); margin-bottom: 1rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                        <rect x="3" y="4" width="18" height="16" rx="2"></rect>
                        <line x1="7" y1="8" x2="17" y2="8"></line>
                        <line x1="7" y1="12" x2="17" y2="12"></line>
                        <line x1="7" y1="16" x2="13" y2="16"></line>
                    </svg>
                    🪪 เสียบบัตรประชาชน (Read Smart Card)
                </button>
            </div>
            <form id="memberForm">
                <input type="hidden" id="editMemberId">
                <div id="smartCardPhotoContainer" style="display: none; text-align: center; margin-bottom: 1rem;">
                    <img id="smartCardPhoto" src="" alt="Member Photo"
                        style="width: 100px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                </div>
                <div class="grid-row">
                    <div class="form-group"><label>รหัสสมาชิก</label><input type="text" id="memberIdDisplay" readonly
                            class="readonly-field" placeholder="ออกโดยระบบอัตโนมัติ"></div>
                    <div class="form-group"><label>เลขบัตรประชาชน</label><input type="text" id="memberCitizenId"
                            readonly class="readonly-field" placeholder="จากการเสียบบัตร"></div>
                    <div class="form-group"><label>คำนำหน้า</label><input type="text" id="memberPrefix" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>ชื่อ (TH)</label><input type="text" id="memberFirstName" required
                            readonly class="readonly-field"></div>
                    <div class="form-group"><label>นามสกุล (TH)</label><input type="text" id="memberLastName" required
                            readonly class="readonly-field"></div>
                    <div class="form-group"><label>First Name (EN)</label><input type="text" id="memberFirstNameEn"
                            readonly class="readonly-field"></div>
                    <div class="form-group"><label>Last Name (EN)</label><input type="text" id="memberLastNameEn"
                            readonly class="readonly-field"></div>
                    <div class="form-group"><label>เพศ</label><input type="text" id="memberGender" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>วันเกิด</label><input type="date" id="memberBirthdate" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>เบอร์โทรศัพท์</label><input type="tel" id="memberPhone" required
                            placeholder="0xxxxxxxxx (กรอกมือ)"></div>
                    <div class="form-group"><label>ชื่อเฟสบุ๊ก</label><input type="text" id="memberFacebook"
                            placeholder="ชื่อเฟสบุ๊ก"></div>
                    <div class="form-group"><label>ลิงค์เฟสบุ๊ก</label><input type="text" id="memberFacebookLink"
                            placeholder="ลิงค์เฟสบุ๊ก (URL)"></div>
                    <div class="form-group"><label>วันออกบัตร</label><input type="date" id="memberIssueDate" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>วันหมดอายุ</label><input type="date" id="memberExpiryDate" readonly
                            class="readonly-field"></div>
                    <div class="form-group full-width">
                        <label>ที่อยู่ตามหน้าบัตร (ID Card Address)</label>
                        <textarea id="memberIdCardAddress" rows="3" readonly class="readonly-field"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label>ที่อยู่จัดส่ง (Shipping Address)</label>
                            <button type="button" id="copyAddressBtn" class="receive-btn"
                                style="padding: 4px 10px; font-size: 0.75rem;">ใช้ที่อยู่ตามสำเนาบัตร</button>
                        </div>
                        <textarea id="memberShippingAddress" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-actions" style="margin-top: 1.5rem;">
                    <button type="button" id="closeMemberModal" class="submit-btn"
                        style="background: var(--text-muted);">ยกเลิก</button>
                    <button type="submit" class="submit-btn">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="shopModalTitle">เพิ่มข้อมูลร้านค้า</h2>
            <form id="shopForm">
                <input type="hidden" id="editShopId">
                <div class="grid-row">
                    <div class="form-group full-width"><label>รหัสร้านค้า</label><input type="text" id="shopIdDisplay"
                            readonly class="readonly-field" placeholder="ออกโดยระบบอัตโนมัติ"></div>
                    <div class="form-group full-width"><label>ชื่อร้านค้า</label><input type="text" id="shopModalName"
                            required></div>
                    <div class="form-group full-width">
                        <label>สถานที่ตั้ง (Location)</label>
                        <textarea id="shopLocation" rows="3" required></textarea>
                    </div>
                </div>
                <div class="form-actions" style="margin-top: 1.5rem;">
                    <button type="button" id="closeShopModal" class="submit-btn"
                        style="background: var(--text-muted);">ยกเลิก</button>
                    <button type="submit" class="submit-btn">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Claim Form Modal -->
    <div id="claimFormModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">📋 ทำรายการเคลมประกัน</h2>

            <!-- Policy Details (read-only) -->
            <div class="claim-policy-info"
                style="background: #f1f5f9; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-main);">📄 ข้อมูลกรมธรรม์</h3>
                <div class="grid-row" style="gap: 0.75rem;">
                    <div class="form-group"><label>เลขกรมธรรม์</label><input type="text" id="claimPolicyNumber" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>รหัสสมาชิก</label><input type="text" id="claimMemberId" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>ชื่อลูกค้า</label><input type="text" id="claimCustomerName" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>เบอร์โทรศัพท์</label><input type="text" id="claimCustomerPhone"
                            readonly class="readonly-field"></div>
                    <div class="form-group"><label>รุ่นอุปกรณ์</label><input type="text" id="claimDeviceModel" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>สี</label><input type="text" id="claimColor" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>Serial Number</label><input type="text" id="claimSerial" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>IMEI</label><input type="text" id="claimIMEI" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>แพ็กเกจ</label><input type="text" id="claimPackage" readonly
                            class="readonly-field"></div>
                    <div class="form-group"><label>วันเริ่มคุ้มครอง</label><input type="text" id="claimStartDate"
                            readonly class="readonly-field"></div>
                    <div class="form-group"><label>วันสิ้นสุดคุ้มครอง</label><input type="text" id="claimEndDate"
                            readonly class="readonly-field"></div>
                </div>
            </div>

            <!-- Claim Form -->
            <form id="claimForm" enctype="multipart/form-data">
                <input type="hidden" id="claimWarrantyId">
                <div
                    style="background: linear-gradient(135deg, #fef3c7, #fff7ed); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-size: 1rem; color: #92400e;">📝 รายละเอียดการแจ้งเคลม</h3>
                    <div class="grid-row" style="gap: 0.75rem;">
                        <div class="form-group">
                            <label>วันที่แจ้งเคลม</label>
                            <input type="text" id="claimDate" readonly class="readonly-field">
                        </div>
                        <div class="form-group">
                            <label>รหัสการเคลม (Claim ID)</label>
                            <input type="text" id="claimIdDisplay" readonly class="readonly-field"
                                placeholder="สร้างอัตโนมัติโดยระบบ">
                        </div>
                        <div class="form-group">
                            <label>ผู้ทำรายการ</label>
                            <input type="text" id="claimStaffName" readonly class="readonly-field">
                        </div>
                    </div>

                    <!-- Pre-repair Inspection Checklist -->
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #cbd5e1;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                            🛠️ ตรวจสอบสภาพเครื่องก่อนรับ (Device Condition Checklist)
                        </label>
                        <p style="font-size: 0.82rem; color: #b45309; margin-bottom: 0.75rem;">⚠️ ทุกรายการต้องกดเลือก
                            <strong>ปกติ</strong> หรือ <strong>ไม่ปกติ</strong> หากไม่ปกติต้องระบุเหตุผล</p>
                        <style>
                            .condition-checklist {
                                display: flex;
                                flex-direction: column;
                                gap: 0.65rem;
                                margin-top: 0.5rem;
                            }

                            .condition-row {
                                background: #f8fafc;
                                border: 1.5px solid #e2e8f0;
                                border-radius: 10px;
                                padding: 0.65rem 1rem;
                                transition: border-color 0.2s;
                            }

                            .condition-row.is-normal {
                                border-color: #22c55e;
                                background: #f0fdf4;
                            }

                            .condition-row.is-abnormal {
                                border-color: #ef4444;
                                background: #fef2f2;
                            }

                            .condition-row-top {
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                gap: 0.5rem;
                            }

                            .condition-label {
                                font-size: 0.9rem;
                                color: #334155;
                                font-weight: 500;
                                flex: 1;
                            }

                            .condition-btns {
                                display: flex;
                                gap: 0.4rem;
                            }

                            .cond-btn {
                                padding: 0.3rem 0.9rem;
                                border-radius: 20px;
                                border: 1.5px solid #cbd5e1;
                                background: white;
                                font-size: 0.82rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.15s;
                                color: #64748b;
                            }

                            .cond-btn:hover {
                                transform: translateY(-1px);
                            }

                            .cond-btn.normal-active {
                                background: #22c55e;
                                border-color: #16a34a;
                                color: white;
                            }

                            .cond-btn.abnormal-active {
                                background: #ef4444;
                                border-color: #dc2626;
                                color: white;
                            }

                            .condition-reason {
                                margin-top: 0.5rem;
                                display: none;
                            }

                            .condition-reason textarea {
                                width: 100%;
                                border: 1.5px solid #fca5a5;
                                border-radius: 8px;
                                padding: 0.4rem 0.6rem;
                                font-size: 0.85rem;
                                resize: none;
                                font-family: inherit;
                                background: #fff1f1;
                            }

                            .condition-reason textarea:focus {
                                outline: none;
                                border-color: #ef4444;
                            }
                        </style>
                        <div class="condition-checklist" id="deviceConditionChecklist">
                            <!-- Items injected by JS for maintainability -->
                        </div>
                        <script>
                            (function () {
                                const items = [
                                    { key: 'exterior', label: 'ตัวเครื่องภายนอก' },
                                    { key: 'screen', label: 'หน้าจอ' },
                                    { key: 'assembly', label: 'การประกอบ' },
                                    { key: 'appleLogo', label: 'โลโก้ Apple' },
                                    { key: 'buttons', label: 'ปุ่มต่างๆ' },
                                    { key: 'chargingPort', label: 'พอร์ตชาร์จ' },
                                    { key: 'simTray', label: 'ช่องใส่ซิม' },
                                    { key: 'imeiMatch', label: 'IMEI ตรงกัน' },
                                    { key: 'modelMatch', label: 'Model เครื่อง' },
                                    { key: 'screenTouch', label: 'หน้าจอ/ทัชสกรีน' },
                                    { key: 'faceIdTouchId', label: 'Face ID / Touch ID' },
                                    { key: 'cameras', label: 'กล้องหน้า/กล้องหลัง' },
                                    { key: 'speakerMic', label: 'ลำโพง/ไมค์' },
                                    { key: 'connectivity', label: 'การเชื่อมต่อ' },
                                    { key: 'battery', label: 'แบตเตอรี่' },
                                    { key: 'warrantyVoid', label: 'ประกัน/วอยด์' }
                                ];
                                const container = document.getElementById('deviceConditionChecklist');
                                if (!container) return;
                                items.forEach(item => {
                                    const row = document.createElement('div');
                                    row.className = 'condition-row';
                                    row.dataset.key = item.key;
                                    row.innerHTML = `
                                    <div class="condition-row-top">
                                        <span class="condition-label">${item.label}</span>
                                        <div class="condition-btns">
                                            <button type="button" class="cond-btn normal-btn" data-key="${item.key}">✅ ปกติ</button>
                                            <button type="button" class="cond-btn abnormal-btn" data-key="${item.key}">❌ ไม่ปกติ</button>
                                        </div>
                                    </div>
                                    <div class="condition-reason" id="reason-${item.key}">
                                        <textarea rows="2" id="reason-text-${item.key}" placeholder="ระบุเหตุผลที่ไม่ปกติ..."></textarea>
                                    </div>`;
                                    const normalBtn = row.querySelector('.normal-btn');
                                    const abnormalBtn = row.querySelector('.abnormal-btn');
                                    const reasonDiv = row.querySelector('.condition-reason');
                                    normalBtn.addEventListener('click', () => {
                                        row.className = 'condition-row is-normal';
                                        normalBtn.classList.add('normal-active');
                                        abnormalBtn.classList.remove('abnormal-active');
                                        reasonDiv.style.display = 'none';
                                    });
                                    abnormalBtn.addEventListener('click', () => {
                                        row.className = 'condition-row is-abnormal';
                                        abnormalBtn.classList.add('abnormal-active');
                                        normalBtn.classList.remove('normal-active');
                                        reasonDiv.style.display = 'block';
                                    });
                                    container.appendChild(row);
                                });
                            })();
                        </script>
                    </div>

                    <div class="form-group full-width" style="margin-top: 0.75rem;">
                        <label>รายละเอียดอาการเสีย *</label>
                        <textarea id="claimSymptoms" rows="4" required
                            placeholder="อธิบายอาการเสียหาย เช่น จอแตก, เครื่องตก, น้ำเข้า ฯลฯ"
                            style="width: 100%; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group full-width" style="margin-top: 0.75rem;">
                        <label>อัพโหลดรูปภาพอาการเสีย (รองรับหลายรูป)</label>
                        <input type="file" id="claimImages" accept="image/*" multiple
                            style="padding: 0.75rem; border: 2px dashed #d1d5db; border-radius: 8px; width: 100%; cursor: pointer; background: #fefce8;">
                        <div id="claimImagePreview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                        </div>
                    </div>

                    <div class="form-group full-width" style="margin-top: 0.75rem;">
                        <label style="font-weight: 600;">การคืนเครื่อง (Return Method) *</label>
                        <div class="radio-options" style="margin-top: 0.5rem;">
                            <label class="radio-label">
                                <input type="radio" name="returnMethod" value="pickup" required>
                                <span class="radio-custom"></span>มารับเองที่ร้าน
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="returnMethod" value="delivery">
                                <span class="radio-custom"></span>จัดส่ง
                            </label>
                        </div>
                        <div id="pickupBranchGroup" style="display: none; margin-top: 0.75rem;">
                            <label>ชื่อสาขา / ชื่อร้าน</label>
                            <input type="text" id="claimPickupBranch" placeholder="ระบุชื่อสาขาที่จะมารับเครื่อง">
                        </div>

                        <!-- New Delivery Address Options -->
                        <div id="deliveryOptionsGroup"
                            style="display: none; margin-top: 1rem; padding: 1rem; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px;">
                            <label style="font-weight: 600; color: #1e40af; margin-bottom: 0.75rem; display: block;">📍
                                เลือกที่อยู่จัดส่ง</label>
                            <div class="radio-options"
                                style="flex-direction: column; gap: 0.75rem; align-items: flex-start;">
                                <label class="radio-label">
                                    <input type="radio" name="deliveryAddressType" value="card">
                                    <span class="radio-custom"></span>ตามที่อยู่ตามหน้าบัตร
                                    <div id="displayCardAddress"
                                        style="font-size: 0.8rem; color: #64748b; margin-left: 2rem; margin-top: 2px;">
                                    </div>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="deliveryAddressType" value="memberShipping">
                                    <span class="radio-custom"></span>ตามที่อยู่จัดส่ง
                                    <div id="displayShippingAddress"
                                        style="font-size: 0.8rem; color: #64748b; margin-left: 2rem; margin-top: 2px;">
                                    </div>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="deliveryAddressType" value="new">
                                    <span class="radio-custom"></span>หรือเพิ่มที่อยู่ใหม่
                                </label>
                            </div>
                            <div id="newAddressGroup" style="display: none; margin-top: 0.75rem;">
                                <textarea id="claimNewAddress" rows="3" placeholder="ระบุพิกัดที่อยู่จัดส่งใหม่..."
                                    style="width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 0.5rem;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions" style="margin-top: 1.5rem;">
                    <button type="button" id="closeClaimFormModal" class="submit-btn"
                        style="background: var(--text-muted);">ยกเลิก</button>
                    <button type="submit" class="submit-btn"
                        style="background: linear-gradient(135deg, #f59e0b, #d97706);">💾 บันทึกรายการเคลม</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Claim Contract / Signature Modal -->
    <div id="claimContractModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;"
            id="claimContractPrintArea">
            <!-- Print Header -->
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <img src="logo_easycare.png" alt="Logo" style="height: 60px; margin-bottom: 0.5rem;">
                <h2 style="color: var(--primary); margin: 0;">รายละเอียดสัญญาการรับเครื่อง</h2>
                <p style="color: var(--text-muted); font-size: 0.85rem;">EasyCare Mobile Insurance Warranty - Claim
                    Contract</p>
            </div>

            <!-- Claim Details -->
            <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3
                    style="font-size: 1rem; color: var(--text-main); margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
                    📋 รายละเอียดการเคลม</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                    <div><strong>รหัสเคลม:</strong> <span id="contractClaimId">-</span></div>
                    <div><strong>วันที่แจ้งเคลม:</strong> <span id="contractClaimDate">-</span></div>
                    <div><strong>เลขกรมธรรม์:</strong> <span id="contractPolicyNumber">-</span></div>
                    <div><strong>รหัสสมาชิก:</strong> <span id="contractMemberId">-</span></div>
                    <div><strong>ชื่อลูกค้า:</strong> <span id="contractCustomerName">-</span></div>
                    <div><strong>เบอร์โทรศัพท์:</strong> <span id="contractCustomerPhone">-</span></div>
                    <div><strong>รุ่นอุปกรณ์:</strong> <span id="contractDeviceModel">-</span></div>
                    <div><strong>ผู้ทำรายการ:</strong> <span id="contractStaffName">-</span></div>
                    <div style="grid-column: 1 / -1;"><strong>อาการ:</strong> <span id="contractSymptoms">-</span></div>
                    <div
                        style="grid-column: 1 / -1; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e2e8f0;">
                        <strong>สภาพเครื่องก่อนรับ (Device Condition):</strong>
                        <div id="contractConditionGrid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 5px; margin-top: 5px; font-size: 0.85rem;">
                            <!-- Checkbox items will be populated by script -->
                        </div>
                    </div>
                    <div><strong>การคืนเครื่อง:</strong> <span id="contractReturnMethod">-</span></div>
                    <div id="contractBranchRow" style="display: none;"><strong>สาขา:</strong> <span
                            id="contractPickupBranch">-</span></div>
                </div>

                <!-- Uploaded Images -->
                <div id="contractImagesSection" style="margin-top: 1rem; display: none;">
                    <strong>รูปภาพประกอบ:</strong>
                    <div id="contractImages" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
                </div>
            </div>

            <!-- Actions (hidden on print) -->
            <div class="claim-contract-actions"
                style="display: flex; gap: 10px; justify-content: center; margin-top: 1.5rem;">
                <button type="button" id="closeContractModal" class="btn-cancel">✕ ปิด</button>
                <button type="button" id="printContractBtn" class="submit-btn"
                    style="background: linear-gradient(135deg, #3b82f6, #2563eb);">🖨️ พิมพ์เอกสาร</button>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusUpdateModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                ติดตามสถานะการซ่อม
            </h2>

            <!-- Claim Info Bar -->
            <div id="statusClaimInfo"
                style="background: #f1f5f9; border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            </div>

            <!-- Timeline Section -->
            <div id="statusTimeline" class="status-timeline"></div>

            <!-- Cost Summary -->
            <div id="statusCostSummary" class="status-cost-summary">
                <span>สรุปยอดการซ่อมครั้งนี้ทั้งหมด:</span>
                <span id="statusTotalCost" style="font-size: 1.4rem; font-weight: 700;">0 บาท</span>
            </div>

            <!-- Update Form -->
            <div
                style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                <h3 style="margin-bottom: 1rem; font-size: 1rem; color: #1e40af;">📝 เพิ่มการอัปเดตใหม่</h3>
                <div class="grid-row" style="gap: 0.75rem;">
                    <div class="form-group">
                        <label>รายละเอียดการอัปเดต *</label>
                        <input type="text" id="updateTitle" placeholder="เช่น ส่งเครื่องไปศูนย์, ซ่อมเครื่อง, ทดสอบ"
                            required>
                    </div>
                    <div class="form-group">
                        <label>ค่าใช้จ่าย (บาท)</label>
                        <input type="number" id="updateCost" placeholder="0" min="0" value="0">
                    </div>
                </div>
                <div class="form-group full-width" style="margin-top: 0.75rem;">
                    <label>อัพโหลดรูปภาพประกอบ (รองรับหลายรูป)</label>
                    <input type="file" id="updateImages" accept="image/*" multiple
                        style="padding: 0.75rem; border: 2px dashed #93c5fd; border-radius: 8px; width: 100%; cursor: pointer; background: #eff6ff;">
                    <div id="updateImagePreview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    </div>
                </div>
                <input type="hidden" id="statusUpdateClaimId">
                <button type="button" id="submitUpdateBtn" class="submit-btn full-width"
                    style="margin-top: 1rem; background: linear-gradient(135deg, #3b82f6, #2563eb);">
                    💾 บันทึกการอัปเดต
                </button>
            </div>

            <!-- Complete Section -->
            <div
                style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #86efac; border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                <h3 style="margin-bottom: 0.75rem; font-size: 1rem; color: #166534;">✅ ปิดงาน — ลูกค้ามารับเครื่องแล้ว
                </h3>
                <p style="color: #15803d; font-size: 0.85rem; margin-bottom: 1rem;">อัพโหลดรูปภาพวันรับเครื่อง (ถ้ามี)
                    แล้วกดยืนยันเพื่อปิดงานนี้</p>
                <div class="form-group full-width">
                    <input type="file" id="completeImages" accept="image/*" multiple
                        style="padding: 0.75rem; border: 2px dashed #86efac; border-radius: 8px; width: 100%; cursor: pointer; background: #f0fdf4;">
                    <div id="completeImagePreview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    </div>
                </div>
                <button type="button" id="completeClaimBtn" class="submit-btn full-width"
                    style="margin-top: 1rem; background: linear-gradient(135deg, #22c55e, #16a34a); font-size: 1.1rem; padding: 1rem;">
                    🎉 ลูกค้ามารับเครื่องแล้ว — ปิดงาน
                </button>
            </div>

            <!-- Close Button -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 1.5rem;">
                <button type="button" id="closeStatusUpdateModal" class="btn-cancel">✕ ปิด</button>
            </div>
        </div>
    </div>

    <!-- Claim History Modal -->
    <div id="claimHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                ประวัติการเคลม
            </h2>
            <div id="claimHistoryList" style="display: flex; flex-direction: column; gap: 1rem;"></div>
            <div id="claimHistoryEmpty" class="empty-state" style="display: none; padding: 2rem;">
                <p>ไม่พบประวัติการเคลมสำหรับรายการนี้</p>
            </div>
            <div style="display: flex; justify-content: center; margin-top: 1.5rem;">
                <button type="button" id="closeClaimHistoryModal" class="btn-cancel"
                    style="width: auto; min-width: 120px;">✕ ปิด</button>
            </div>
        </div>
    </div>

    <!-- =================== CLAIM RECEIPT VIEW (in-page, shown when printing) =================== -->
    <!--
        แทนที่การเปิดหน้าต่างใหม่ (window.open) ส่วนนี้จะแสดงผลภายในหน้าเดิม
        และซ่อน UI หลักเมื่อมีการพิมพ์ผ่าน @media print
        เรียกใช้งานผ่าน window.showClaimReceipt(claimData) จาก script.js
    -->
    <div id="claimReceiptView">
        <!-- Print Buttons (hidden on print) -->
        <div class="cr-print-buttons">
            <button onclick="window.printClaimReceipt()" class="cr-print-button">
                <svg style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                    </path>
                </svg>
                พิมพ์เอกสาร
            </button>
            <button onclick="window.closeClaimReceipt()" class="cr-close-button">ปิดหน้าต่าง</button>
        </div>

        <div class="cr-page">
            <div class="cr-page-content">
                <!-- Header -->
                <div class="cr-header">
                    <div class="cr-logo-section">
                        <img src="logo_easycare.png" alt="Easy.Care Logo" style="height:20px;object-fit:contain;">
                    </div>
                    <div class="cr-company-name">
                        <h1>อีซี่แคร์</h1>
                        <h2>Easy.Care</h2>
                    </div>
                    <div class="cr-date-section">
                        วันที่ <span id="cr_claimDate">.....................................................</span>
                    </div>
                </div>

                <div style="text-align:center;margin-bottom:10px;">
                    <strong style="font-size:20px;">เอกสารรับเครื่องเคลม (Claim Receipt)</strong>
                </div>

                <div class="cr-form-container">
                    <!-- Document Info Row -->
                    <div class="cr-row">
                        <div class="cr-col cr-w-40">
                            <span class="cr-label">เลขที่สมาชิก</span>
                            <span id="cr_memberId" class="cr-dotted-line" style="width:150px;"></span>
                        </div>
                        <div class="cr-col cr-w-60">
                            <span class="cr-label" style="font-weight:bold;">เลขที่เคลม</span>
                            <span id="cr_claimId" style="font-weight:bold;font-size:22px;margin-left:10px;"></span>
                        </div>
                    </div>

                    <!-- 1. Customer & Policy Information -->
                    <div class="cr-row cr-section-header-row">
                        <div class="cr-col cr-w-100">
                            <span class="cr-section-title">1. ข้อมูลกรมธรรม์และลูกค้า (Customer & Policy
                                Information)</span>
                        </div>
                    </div>
                    <div class="cr-row">
                        <div class="cr-col cr-w-60" style="border-right:1.5px solid #000;">
                            <div class="cr-field">
                                <span class="cr-label">ชื่อลูกค้า</span>
                                <span id="cr_customerName" class="cr-dotted-line" style="width:200px;"></span>
                            </div>
                            <div class="cr-field">
                                <span class="cr-label">เบอร์โทรศัพท์</span>
                                <span id="cr_customerPhone" class="cr-dotted-line" style="width:150px;"></span>
                            </div>
                            <div class="cr-field">
                                <span class="cr-label">เลขกรมธรรม์</span>
                                <span id="cr_policyNumber" class="cr-dotted-line" style="width:180px;"></span>
                            </div>
                        </div>
                        <div class="cr-col cr-w-40">
                            <span class="cr-section-title">สถานที่ตั้งบริษัท</span>
                            <div style="padding:5px;line-height:1.4;font-size:16px;">
                                62 ถนนพิพิธภักดี ตำบลสะเตง<br>
                                อำเภอเมืองยะลา จังหวัดยะลา
                            </div>
                        </div>
                    </div>

                    <!-- 2. Device Information -->
                    <div class="cr-row cr-section-header-row">
                        <div class="cr-col cr-w-100">
                            <span class="cr-section-title">2. ข้อมูลอุปกรณ์ (Device Information)</span>
                        </div>
                    </div>
                    <div class="cr-row">
                        <div class="cr-col cr-w-100">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <div>
                                    <div class="cr-field">
                                        <span class="cr-label">รุ่นอุปกรณ์</span>
                                        <span id="cr_deviceModel" class="cr-dotted-line" style="width:180px;"></span>
                                    </div>
                                    <div class="cr-field">
                                        <span class="cr-label">Serial Number</span>
                                        <span id="cr_deviceSerial" class="cr-dotted-line" style="width:150px;"></span>
                                    </div>
                                </div>
                                <div>
                                    <div class="cr-field">
                                        <span class="cr-label">สี</span>
                                        <span id="cr_deviceColor" class="cr-dotted-line" style="width:100px;"></span>
                                        <span class="cr-label" style="margin-left:15px;">ความจุ</span>
                                        <span id="cr_deviceCapacity" class="cr-dotted-line" style="width:80px;"></span>
                                    </div>
                                    <div class="cr-field">
                                        <span class="cr-label">IMEI</span>
                                        <span id="cr_deviceIMEI" class="cr-dotted-line" style="width:200px;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Claim Details -->
                    <div class="cr-row cr-section-header-row">
                        <div class="cr-col cr-w-100">
                            <span class="cr-section-title">3. รายละเอียดการเคลม (Claim Details)</span>
                        </div>
                    </div>
                    <div class="cr-row">
                        <div class="cr-col cr-w-100">
                            <div style="margin-bottom:10px;">
                                <span class="cr-label" style="font-weight:bold;">อาการที่แจ้ง (Reported
                                    Symptoms):</span>
                            </div>
                            <div id="cr_symptoms"
                                style="border:1px solid #ddd;padding:10px;min-height:60px;background:#fafafa;line-height:1.5;">
                            </div>
                        </div>
                    </div>

                    <!-- 4. Return Method -->
                    <div class="cr-row cr-section-header-row">
                        <div class="cr-col cr-w-100">
                            <span class="cr-section-title">4. วิธีการรับคืนอุปกรณ์ (Return Method)</span>
                        </div>
                    </div>
                    <div class="cr-row">
                        <div class="cr-col cr-w-50">
                            <div class="cr-field">
                                <span class="cr-label">วิธีการรับคืน</span>
                                <span id="cr_returnMethod" class="cr-dotted-line" style="width:180px;"></span>
                            </div>
                        </div>
                        <div class="cr-col cr-w-50">
                            <div class="cr-field">
                                <span class="cr-label" id="cr_branchLabel">สาขาที่รับ</span>
                                <span id="cr_pickupBranch" class="cr-dotted-line" style="width:180px;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Images (if available) -->
                    <div id="cr_imagesSection" class="cr-row" style="display:none;">
                        <div class="cr-col cr-w-100">
                            <div style="margin-bottom:8px;">
                                <span class="cr-label" style="font-weight:bold;">รูปภาพประกอบ (Supporting
                                    Images):</span>
                            </div>
                            <div class="cr-images-grid" id="cr_imageContainer"></div>
                        </div>
                    </div>

                    <!-- 6. Terms & Conditions -->
                    <div class="cr-row cr-section-header-row">
                        <div class="cr-col cr-w-100">
                            <span class="cr-section-title">5. เงื่อนไขการรับบริการ (Terms & Conditions)</span>
                        </div>
                    </div>
                    <div class="cr-row">
                        <div class="cr-col cr-w-100">
                            <ul class="cr-terms-list">
                                <li>เอกสารฉบับนี้ใช้เป็นหลักฐานในการรับฝากเครื่องเพื่อตรวจสอบและดำเนินการแก้ไขตามเงื่อนไขการรับประกัน
                                </li>
                                <li>โปรดนำเอกสารฉบับนี้และบัตรประชาชนมาแสดงทุกครั้งที่ติดต่อขอรับเครื่องคืน</li>
                                <li>ทางบริษัทฯ จะไม่รับผิดชอบต่อข้อมูลสูญหาย หรือความเสียหายใดๆ ต่อข้อมูลในตัวเครื่อง
                                    โปรดสำรองข้อมูลก่อนส่งซ่อม</li>
                                <li>หากไม่มารับเครื่องคืนภายใน 90 วัน นับจากวันที่แจ้งให้ทราบ ทางบริษัทฯ
                                    ขอสงวนสิทธิ์ในการดำเนินการตามความเหมาะสม</li>
                            </ul>
                            <div style="margin-top:15px;font-size:16px;line-height:1.5;">
                                <p style="margin:5px 0;"><strong>หมายเหตุ:</strong>
                                    การลงลายมือชื่อด้านล่างนี้
                                    ถือว่าสมาชิกได้รับทราบและตกลงตามเงื่อนไขที่ระบุไว้ข้างต้นทุกประการ
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signatures -->
            <div class="cr-signature-section">
                <div class="cr-sig-block">
                    <span style="font-weight:bold;">สมาชิกตะกาฟุล</span>
                    <div class="cr-sig-line" id="cr_customerSigBox"></div>
                    <div class="cr-sig-name">(<span
                            id="cr_signCustomerName">..................................................</span>)</div>
                </div>
                <div class="cr-sig-block">
                    <span style="font-weight:bold;">พนักงานอีซี่แคร์</span>
                    <div class="cr-sig-line" id="cr_staffSigBox"></div>
                    <div class="cr-sig-name">(<span
                            id="cr_signStaffName">..................................................</span>)</div>
                </div>
                <div class="cr-sig-block">
                    <span>ผู้อนุมัติ</span>
                    <div><img src="ceo.png" alt="CEO" style="width:130px;height:65px;"></div>
                    <div class="cr-sig-name">(อัสมา ปอโต๊ะ)</div>
                </div>
            </div>
        </div>
    </div>
    <!-- =================== END CLAIM RECEIPT VIEW =================== -->

    <script src="script.js"></script>

    <!-- =================== CLAIM RECEIPT LOGIC (inline, replaces claim_receipt.html script) =================== -->
    <script>
        /**
         * showClaimReceipt(claimData)
         * ----------------------------
         * เรียกจาก script.js แทน window.open('claim_receipt.html')
         * รับ object claimData โดยตรง (ไม่ต้องผ่าน localStorage)
         *
         * claimData shape:
         * {
         *   claimId, claimDate, customerName, memberId, customerPhone,
         *   policyNumber, deviceModel, warrantyId,
         *   symptoms, returnMethod, pickupBranch,
         *   customerSignature, staffSignature, staffName,
         *   images: []   // array ของ URL หรือ base64
         * }
         */
        window.showClaimReceipt = async function (claim) {
            if (!claim) {
                alert('ไม่พบข้อมูลการเคลม');
                return;
            }

            // Helper
            const formatThaiDate = (dateStr) => {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
            };

            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val || '-';
            };

            // Populate
            set('cr_claimId', claim.claimId);
            document.getElementById('cr_claimDate').textContent = claim.claimDate
                ? formatThaiDate(claim.claimDate) : '';

            set('cr_memberId', claim.memberId);
            set('cr_customerName', claim.customerName);
            set('cr_customerPhone', claim.customerPhone);
            set('cr_policyNumber', claim.policyNumber);
            set('cr_deviceModel', claim.deviceModel);
            set('cr_symptoms', claim.symptoms);
            set('cr_returnMethod', claim.returnMethod === 'pickup' ? 'รับเองที่สาขา' : 'จัดส่งทางไปรษณีย์');

            const branchLabel = document.getElementById('cr_branchLabel');
            if (claim.returnMethod === 'pickup') {
                if (branchLabel) branchLabel.textContent = 'สาขาที่รับ';
                set('cr_pickupBranch', claim.pickupBranch || '-');
            } else {
                if (branchLabel) branchLabel.textContent = 'ที่อยู่จัดส่ง';
                set('cr_pickupBranch', claim.deliveryAddressDetail || '-');
            }

            // Device detail from API
            const serialEl = document.getElementById('cr_deviceSerial');
            const colorEl = document.getElementById('cr_deviceColor');
            const capEl = document.getElementById('cr_deviceCapacity');
            const imeiEl = document.getElementById('cr_deviceIMEI');

            if (claim.warrantyId) {
                try {
                    const res = await fetch(`/api/warranties/${claim.warrantyId}`);
                    const warranty = await res.json();
                    if (warranty && warranty.device) {
                        if (colorEl) colorEl.textContent = warranty.device.color || '-';
                        if (capEl) capEl.textContent = warranty.device.capacity || '-';
                        if (serialEl) serialEl.textContent = warranty.device.serial || '-';
                        if (imeiEl) imeiEl.textContent = warranty.device.imei || '-';
                    }
                } catch (e) {
                    [serialEl, colorEl, capEl, imeiEl].forEach(el => { if (el) el.textContent = '-'; });
                }
            } else {
                [serialEl, colorEl, capEl, imeiEl].forEach(el => { if (el) el.textContent = '-'; });
            }

            // Signatures
            const customerSigBox = document.getElementById('cr_customerSigBox');
            const staffSigBox = document.getElementById('cr_staffSigBox');
            if (customerSigBox) {
                customerSigBox.innerHTML = claim.customerSignature
                    ? `<img src="${claim.customerSignature}" class="cr-signature-img" alt="Customer Signature">`
                    : '';
            }
            if (staffSigBox) {
                staffSigBox.innerHTML = claim.staffSignature
                    ? `<img src="${claim.staffSignature}" class="cr-signature-img" alt="Staff Signature">`
                    : '';
            }
            set('cr_signCustomerName', claim.customerName || '..................................');
            set('cr_signStaffName', claim.staffName || '..................................');

            // Images
            const imgContainer = document.getElementById('cr_imageContainer');
            const imgSection = document.getElementById('cr_imagesSection');
            if (imgContainer) imgContainer.innerHTML = '';
            if (claim.images && claim.images.length > 0 && imgSection && imgContainer) {
                imgSection.style.display = 'flex';
                claim.images.forEach((imgUrl, idx) => {
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.alt = `รูปภาพที่ ${idx + 1}`;
                    imgContainer.appendChild(img);
                });
            } else if (imgSection) {
                imgSection.style.display = 'none';
            }

            // Show receipt view, hide app
            document.getElementById('claimReceiptView').style.display = 'block';
            document.getElementById('app').style.display = 'none';
            const regView = document.getElementById('registrationView');
            if (regView) regView.style.display = 'none';
        };

        /** พิมพ์ใบเสร็จ */
        window.printClaimReceipt = function () {
            window.print();
        };

        /** ปิดหน้าใบเสร็จและกลับสู่ app */
        window.closeClaimReceipt = function () {
            document.getElementById('claimReceiptView').style.display = 'none';
            document.getElementById('app').style.display = '';
        };
    </script>
</body>

</html>